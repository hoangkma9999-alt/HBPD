<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Happy Birthday ‚Äî Secure</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <style>
    :root{
      --accent1: #ff4da6;
      --accent2: #6af7e0;
      --glass: rgba(255,255,255,0.06);
      --glass-strong: rgba(255,255,255,0.09);
    }
    *{box-sizing:border-box}
    body {
      margin: 0;
      height: 100vh;
      overflow: hidden;
      background: black;
      display: flex;
      justify-content: center;
      align-items: center;
      font-family: 'Pacifico', cursive;
      perspective: 1000px;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .smallText {
      font-size: 0.5em;
      line-height: 1.4;
    }
    /* ch·ªØ hi·ªÉn th·ªã chung */
    #message {
      font-size: 6em; /* gi·ªØ nguy√™n m·∫∑c ƒë·ªãnh cho ch·ªØ Happy, Birthday,... */
      text-align: center;
      margin: 20px 0;
    }

    /* ri√™ng cho s·ªë 3-2-1 */
    #message:has(.countdown) {
      font-size: 6em;       /* üëà to g·∫•p 3 l·∫ßn */
      font-weight: bold;
      color: #ffeb3b;       /* v√†ng r·ª±c cho n·ªïi b·∫≠t */
      text-shadow: 2px 2px 10px rgba(0,0,0,0.6);
    }
        #giftChoice {
      display:none;
      position: fixed;
      z-index: 9999;
      left: 50%;
      top: 60%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.7);
      padding: 20px;
      border-radius: 12px;
      color: white;
      text-align: center;
      min-width: 300px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
    }
    #giftChoice button {
      margin: 10px;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }
    #btnYes { background: pink; }
    #btnNo  { background: lightgray; }


    /* Thi·ªáp PNG */
#cardImage {
  display: none;
  width: 62%;     /* üëà v√≠ d·ª•: chi·∫øm 70% chi·ªÅu ngang m√†n h√¨nh */
  max-width: 62%;
  margin: 20px auto;
  transform-style: preserve-3d;
  backface-visibility: hidden;
}

/* Hi·ªáu ·ª©ng l·∫≠t ng·ª≠a 3D */
@keyframes flipCard {
  0%   { opacity: 0; transform: rotateY(90deg) scale(0.8); }
  100% { opacity: 1; transform: rotateY(0deg) scale(1); }
}
.flipCard { animation: flipCard 1.2s ease forwards; }

@keyframes slideInCard {
  from { transform: translateX(-120%); opacity: 0; }
  to   { transform: translateX(0); opacity: 1; }
}

.card-side {
  position: absolute;
  top: 0;
  width: 50%;
  height: 100%;
  background-size: cover;
  backface-visibility: hidden;
  box-shadow: 0 4px 20px rgba(0,0,0,0.5);
}

/* C√°nh tr√°i */
.card-side.left {
  left: 0;
  background-image: url('a.png');
  transform-origin: left center;
  transform: rotateY(180deg);   /* ban ƒë·∫ßu g·∫≠p l·∫°i */
}

.card-side.right {
  right: 0;
  background-image: url('a.png');
  transform-origin: right center;
  transform: rotateY(-180deg);  /* ban ƒë·∫ßu g·∫≠p l·∫°i */
}
#giftForm input,
#giftForm select {
  font-size: 8px;   /* ngƒÉn zoom khi nh·∫≠p tr√™n mobile */
}
.card-inside {
  position: absolute;
  inset: 0;
  background: white;
  text-align: center;
  padding: 20px;
}
.card-inside img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Khi m·ªü */
.open .left  { animation: openLeft 3s forwards; }
.open .right { animation: openRight 3s forwards 0.5s; }

@keyframes openLeft {
  from { transform: rotateY(180deg); }
  to   { transform: rotateY(0deg); }
}
@keyframes openRight {
  from { transform: rotateY(-180deg); }
  to   { transform: rotateY(0deg); }
}
/* Hi·ªáu ·ª©ng card tr∆∞·ª£t t·ª´ tr√°i + l·∫≠t 3D */
@keyframes slideFlipIn {
  0%   { opacity: 0; transform: translateX(-150%) rotateY(90deg) scale(0.8); }
  70%  { opacity: 1; transform: translateX(20px) rotateY(-10deg) scale(1.05); }
  100% { opacity: 1; transform: translateX(0) rotateY(0) scale(1); }
}

.slideFlipIn { animation: slideFlipIn 5s ease forwards; }


/* Hi·ªáu ·ª©ng l·∫≠t ng·ª≠a 3D */
@keyframes flipCard {
  0%   { opacity: 0; transform: rotateY(90deg) scale(0.8); }
  100% { opacity: 1; transform: rotateY(0deg) scale(1); }
}
.flipCard { animation: flipCard 1.2s ease forwards; }

    /* ========== LOCK SCREEN OVERLAY ========== */
    .lock-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(0,0,0,0.70), rgba(0,0,0,0.85));
      z-index: 9999;
      backdrop-filter: blur(6px) saturate(120%);
      -webkit-backdrop-filter: blur(6px) saturate(120%);
      padding: 20px;
    }
        .kbd {
      gap: 4px;          /* gi·∫£m kho·∫£ng c√°ch */
      padding: 2px;
    }

    .btn {
      border-radius: 4px;
      padding: 4px 0;   /* chi·ªÅu cao n√∫t nh·ªè h∆°n */
      font-size: 0.5rem; /* ch·ªØ nh·ªè l·∫°i */
    }
    .lock-card {
      width: min(320px, 80%);
      max-width: 320px;
      margin: auto;
      border-radius: 12px;
      padding: 16px;          /* gi·∫£m kho·∫£ng ƒë·ªám trong */ 
      background: linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
      box-shadow: 0 8px 40px rgba(0,0,0,0.6);
      color: white;
      text-align: center;
      transform: translateY(0);
      transition: transform .45s cubic-bezier(.2,.9,.3,1), opacity .3s;
    }
    /* Mobile: r·ªông h∆°n ƒë·ªÉ n√∫t kh√¥ng b·ªã che m·∫•t */
    @media (max-width: 200px) {
      .lock-card {
        width: 40%;        /* chi·∫øm g·∫ßn h·∫øt chi·ªÅu ngang */
        max-width: 200px;  /* kh√¥ng to qu√° */
        padding: 2px;
      }
      .kbd {
        gap: 2px;
      }
      .btn {
        padding: 2px 0;   /* n√∫t cao h∆°n, d·ªÖ b·∫•m */
        font-size: 1rem;
      }
}
    .lock-header {
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:center;
      margin-bottom: 10px;
    }
    .lock-icon {
      width:66px;
      height:66px;
      border-radius: 50%;
      background: linear-gradient(135deg,var(--accent1),var(--accent2));
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 34px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.45), 0 0 18px rgba(0,0,0,0.15) inset;
    }
    .lock-title {
      text-align:left;
    }
    .lock-title h3{margin:0;font-size:1.2rem;letter-spacing:0.6px}
    .lock-title p{margin:2px 0 0 0;font-size:0.85rem;opacity:0.9}

    .pin-display {
      margin: 18px auto 10px;
      width: min(360px, 88%);
      display:flex;
      gap:14px;
      justify-content:center;
    }
    .dot {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(255, 182, 193, 0.25);
      border: 1px solid rgba(255, 105, 180, 0.5);
      box-shadow: 0 2px 6px rgba(255, 182, 193, 0.5) inset;
      transition: background .18s, transform .12s;
    }
    .dot.filled {
      background: #ff69b4;
      transform: scale(1.1);
      box-shadow: 0 0 10px #ffb6c1, 0 0 16px #ff69b4;
    }

    .kbd {
      margin-top: 14px;
      display:grid;
      grid-template-columns: repeat(3,1fr);
      gap: 12px;
      padding: 8px;
    }
    .btn {
      background: linear-gradient(180deg, #ffd6e7, #ffb6c1);
      border-radius: 14px;
      padding: 16px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      color: #fff;
      font-weight: bold;
      border: 1px solid #ff69b4;
      cursor: pointer;
      transition: transform .12s ease, box-shadow .2s;
      user-select: none;
      box-shadow: 0 4px 12px rgba(255, 105, 180, 0.4);
    }
    .btn:hover { box-shadow: 0 6px 20px rgba(255, 105, 180, 0.6); }
    .btn:active { transform: translateY(3px) scale(.97); box-shadow: 0 3px 8px rgba(255, 105, 180, 0.5); }
    .btn.action {
      grid-column: span 3;
      background: linear-gradient(90deg, #ff69b4, #ff1493);
      font-weight: 700;
      letter-spacing: 0.6px;
      color: #fff;
      text-shadow: 0 0 6px #fff0f5;
      box-shadow: 0 6px 20px rgba(255, 20, 147, 0.6);
    }
    .btn.gray {
      background: linear-gradient(180deg, #ffe6f0, #ffcce0);
      color: #ff1493;
      font-weight: bold;
      border: 1px solid #ff69b4;
    }

    @keyframes shakeX {
      0%{ transform: translateX(0) }
      20%{ transform: translateX(-8px) }
      40%{ transform: translateX(8px) }
      60%{ transform: translateX(-6px) }
      80%{ transform: translateX(6px) }
      100%{ transform: translateX(0) }
    }
    .shake { animation: shakeX .6s cubic-bezier(.36,.07,.19,.97); }

    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -2;
    }

    .confetti {
      position: absolute;
      width: 10px;
      height: 10px;
      background-color: #ff0;
      opacity: 0.8;
      animation: fall linear infinite;
    }
    @keyframes fall {
      0% { transform: translateY(-10px) rotate(0deg); }
      100% { transform: translateY(100vh) rotate(720deg); }
    }

    .scene {
      position: absolute;
      font-size: 4em;
      color: #fff;
      text-align: center;
      text-shadow: 0 0 20px #ff00de, 0 0 40px #00ffe5;
      opacity: 0;
    }

    @keyframes bounceIn {
      0%   { opacity: 0; transform: scale(0.3) translateY(-200px); }
      50%  { opacity: 1; transform: scale(1.1) translateY(20px); }
      70%  { transform: scale(0.9) translateY(-10px); }
      100% { transform: scale(1) translateY(0); }
    }
    .bounceIn { animation: bounceIn 1s ease forwards; }

    @keyframes fadeZoom {
      0%   { opacity: 0; transform: scale(0.5) rotateX(30deg); }
      100% { opacity: 1; transform: scale(1) rotateX(0deg); }
    }
    .fadeZoom { animation: fadeZoom 1.2s ease forwards; }

    @keyframes slideIn {
      0%   { opacity: 0; transform: translateX(-100vw); }
      100% { opacity: 1; transform: translateX(0); }
    }
    .slideIn { animation: slideIn 1s ease forwards; }

    @keyframes flipIn {
      0%   { opacity: 0; transform: rotateX(90deg) scale(0.8); }
      100% { opacity: 1; transform: rotateX(0) scale(1); }
    }
    .flipIn { animation: flipIn 1.2s ease forwards; }

    /* music toggle button */
    #toggleMusic {
      position: fixed;
      top: 15px;
      right: 15px;
      font-size: 24px;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.12);
      border: none;
      border-radius: 50%;
      padding: 10px;
      color: white;
      z-index: 10;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
    }

    #rotateNotice {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      color: pink;
      font-family: 'Pacifico', cursive;
      font-size: 1.6rem;
      display: flex;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 20px;
      z-index: 10000;
      flex-direction: column;
    }

    #rotateNotice img {
      width: 80px;
      margin-top: 12px;
      animation: rotatePhone 2s infinite;
    }

    @keyframes rotatePhone {
      0%   { transform: rotate(0deg); }
      50%  { transform: rotate(90deg); }
      100% { transform: rotate(0deg); }
    }



    /* gift form styling (fixed centered, hidden until end) */
    #giftForm {
      display:none;
      position: fixed;
      z-index: 9998;
      left: 50%;
      top: 60%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.6);
      padding: 20px;
      border-radius: 12px;
      color: white;
      text-align: center;
      min-width: 300px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
    }
    #giftForm input { width: 90%; box-sizing: border-box; }

    @media (max-width:480px){
      .lock-card{ padding:18px }
      .lock-icon{ width:56px;height:56px;font-size:28px }
      .btn{ padding:12px 0;font-size:1.05rem }
      .dot{ width:14px;height:14px }
      #giftForm { width: 92%; left:50%; top: 65%; transform: translate(-50%,-50%); }
    }
  </style>
</head>
<body>
  <canvas id="bg"></canvas>
  <div id="rotateNotice" style="display:none">
    üì± Vui l√≤ng xoay ngang m√†n h√¨nh v√† c·∫Øm tai nghe ƒë·ªÉ ti·∫øp t·ª•c üéÄ
    <img src="https://cdn-icons-png.flaticon.com/512/2088/2088617.png" alt="rotate phone">
  </div>

  <!-- Overlay lock screen -->
  <div id="lockOverlay" class="lock-overlay" aria-hidden="false">
    <div id="lockCard" class="lock-card">
      <div class="lock-header">
        <div class="lock-icon">üîí</div>
        <div class="lock-title">
          <h3>Nh·∫≠p m·∫≠t kh·∫©u ƒë·ªÉ v√†o</h3>
          <p>Nh·∫≠p m√£ PIN (4 ch·ªØ s·ªë) ‚Äî nh·∫≠p sai s·∫Ω th·ª≠ l·∫°i</p>
        </div>
      </div>

      <div class="pin-display" id="pinDisplay">
        <div class="dot" data-pos="0"></div>
        <div class="dot" data-pos="1"></div>
        <div class="dot" data-pos="2"></div>
        <div class="dot" data-pos="3"></div>
      </div>

      <div class="kbd" id="kbd"></div>
    </div>
  </div>

  <!-- Khung hi·ªÉn th·ªã ch·ªØ -->
  <div id="message" class="scene"></div>
  <!-- Thi·ªáp PNG -->
<!-- Thi·ªáp PNG -->
<img id="cardImage" src="HPBD.png" alt="Birthday Card">
      <div id="giftChoice">
      <h2>üéÅ C√≥ m·ªôt m√≥n qu√† nh·ªè nh·ªè - nh·∫≠n nha üéÅ </h2>
      <button id="btnYes">C√≥</button>
      <button id="btnNo">Kh√¥ng</button>
      <p id="funnyMsg" style="display:none; margin-top:10px; color:lightgreen;"></p>
    </div>
  <!-- Form (·∫©n) -->
<div id="giftForm">
  <h2>üåû Th·ª© tui c·∫ßn l√† th√¥ng tin üåû</h2>
  <form id="infoForm">
    <input type="text" id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i" required 
          style="padding:10px; margin:10px; border-radius:8px; font-size:16px;">
    <input type="text" id="address" placeholder="ƒê·ªãa ch·ªâ nh·∫≠n qu√†" required 
          style="padding:10px; margin:10px; border-radius:8px; font-size:16px;">


    <!-- Th√™m l·ª±a ch·ªçn th·ªùi gian -->
    <select id="deliveryTime" required 
            style="padding:10px; margin:10px; border-radius:8px; width:90%;">
      <option value="" disabled selected>Ch·ªçn th·ªùi gian nh·∫≠n qu√†</option>
      <option value="S√°ng">üåÖ Bu·ªïi s√°ng</option>
      <option value="Tr∆∞a">üåû Bu·ªïi tr∆∞a</option>
      <option value="Chi·ªÅu">üåá Bu·ªïi chi·ªÅu</option>
      <option value="T·ªëi">üåô Bu·ªïi t·ªëi</option>
    </select><br>

    <button type="submit" 
            style="padding:10px 20px; margin-top:15px; border-radius:8px; background:pink; border:none; font-weight:bold;">
      G·ª≠i th√¥ng tin
    </button>
  </form>
  <p id="submitMsg" style="display:none; color:lightgreen; margin-top:15px;">
    ‚úÖ ƒê√£ g·ª≠i th√¥ng tin th√†nh c√¥ng!
  </p>
</div>

  <!-- Nh·∫°c -->
  <audio id="music" loop>
    <source src="happy.mp3" type="audio/mpeg">
  </audio>

  <!-- N√∫t b·∫≠t/t·∫Øt nh·∫°c -->
  <button id="toggleMusic">üîá</button>

  <!-- GSAP (gi·ªØ n·∫øu c·∫ßn) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js"></script>

  <!-- Firebase (modular SDK, d√πng duy nh·∫•t) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
  import { getDatabase, ref, push, set } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAX2cKuRDWHeVxroX92hbbJQZbWMLZaUvE",
    authDomain: "hpbd-67d98.firebaseapp.com",
    databaseURL: "https://hpbd-67d98-default-rtdb.firebaseio.com",
    projectId: "hpbd-67d98",
    storageBucket: "hpbd-67d98.firebasestorage.app",
    messagingSenderId: "810250307079",
    appId: "1:810250307079:web:de76a71faf05745c7e0ca2",
    measurementId: "G-22QSWS00YX"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch(e){ /* analytics may fail on some hosts */ }

  const db = getDatabase(app);
/////////////////////////////////
// ========== LOG WRONG EXTRA PASSWORD ==========
window.logWrongExtraPassword = function(input){
  const wrongRef = ref(db, 'wrongExtraAttempts');
  const newRef = push(wrongRef);
  const now = new Date();
  const timestamp = now.toLocaleString("vi-VN", { 
    timeZone: "Asia/Ho_Chi_Minh", 
    hour12: false 
  });
  set(newRef, {
    triedPassword: input,
    timestamp: timestamp,
  });
}
//////////////////////////////////////////////////
  // ========== LOG VISITOR ==========
  function logVisitor() {
    const visitorsRef = ref(db, 'visitors');
    const newRef = push(visitorsRef);
    const now = new Date();
    const timestamp = now.toLocaleString("vi-VN", { 
      timeZone: "Asia/Ho_Chi_Minh", 
      hour12: false 
    });
    set(newRef, {
      timestamp: timestamp,
    });
  }

  // Ghi log ngay khi m·ªü trang
  logVisitor();

  // H√†m l∆∞u th√¥ng tin form v·∫´n gi·ªØ nguy√™n
  window.saveSubmission = async function(phone, address) {
    const submissionsRef = ref(db, 'submissions');
    const newRef = push(submissionsRef);
    const now = new Date();
    const timestamp = now.toLocaleString("vi-VN", { 
      timeZone: "Asia/Ho_Chi_Minh", 
      hour12: false 
    });
    return set(newRef, {
      phone: phone,
      address: address,
      choice: giftChoiceValue,
      timestamp: timestamp
    });
  }
</script>


  <script>
    /* ========== LOCK / PIN LOGIC ========== */
    const CORRECT_PIN = "1809";
    let inputPin = "";

    const lockOverlay = document.getElementById('lockOverlay');
    const pinDots = document.querySelectorAll('.dot');
    const kbd = document.getElementById('kbd');
    const lockCard = document.getElementById('lockCard');

    // build keypad
    const keys = [
      '1','2','3',
      '4','5','6',
      '7','8','9',
      'C','0','‚Üê'
    ];
    keys.forEach(k => {
      const b = document.createElement('button');
      b.className = 'btn' + (k==='C' || k==='‚Üê' ? ' gray' : '');
      b.innerHTML = (k === '‚Üê') ? '‚å´' : (k==='C' ? 'C' : k);
      b.setAttribute('data-key', k);
      kbd.appendChild(b);
    });

    function updateDots(){
      pinDots.forEach((d,i)=>{
        if(i < inputPin.length) d.classList.add('filled'); else d.classList.remove('filled');
      });
    }

    function wrongPinFeedback(){
      lockCard.classList.remove('shake');
      void lockCard.offsetWidth;
      lockCard.classList.add('shake');
      setTimeout(()=> { lockCard.classList.remove('shake'); }, 700);
    }

    function unlock(){
      lockOverlay.style.transition = 'opacity .45s ease, transform .45s ease';
      lockOverlay.style.opacity = 0;
      lockOverlay.style.transform = 'scale(.99) translateY(10px)';
      setTimeout(()=> {
        lockOverlay.style.display = 'none';
        lockOverlay.setAttribute('aria-hidden','true');
      }, 480);
      tryPlayMusicOnUnlock();
    }

    kbd.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      const k = btn.getAttribute('data-key');

      if(k === 'C'){ inputPin = ''; updateDots(); return; }
      if(k === '‚Üê'){ inputPin = inputPin.slice(0,-1); updateDots(); return; }
      if(inputPin.length >= 4) return;
      inputPin += k;
      updateDots();

      if(inputPin.length === 4){
        setTimeout(()=>{
          if(inputPin === CORRECT_PIN){ unlock(); }
          else { wrongPinFeedback(); inputPin = ''; updateDots(); }
        }, 300);
      }
    });

    document.addEventListener('keydown', (e)=>{
      if(lockOverlay.style.display === 'none') return;
      if(e.key >= '0' && e.key <= '9'){
        if(inputPin.length < 4){ inputPin += e.key; updateDots(); }
        if(inputPin.length === 4){
          setTimeout(()=>{ if(inputPin === CORRECT_PIN) unlock(); else { wrongPinFeedback(); inputPin=''; updateDots(); } }, 220);
        }
      } else if(e.key === 'Backspace'){ inputPin = inputPin.slice(0,-1); updateDots(); }
      else if(e.key.toLowerCase() === 'c'){ inputPin = ''; updateDots(); }
    });

    /* ========== MAIN SCENE ANIMATION ========== */
    const messages = [
      { text: "3", effect: "bounceIn" },
      { text: "2", effect: "bounceIn" },
      { text: "1", effect: "bounceIn" },
      { text: "üéâ Happy üéâ", effect: "fadeZoom" },
      { text: "üéÇ Birthday üéÇ", effect: "fadeZoom" },
      { text: "üíñ Di·ªÖm Qu·ª≥nh üíñ", effect: "slideIn" },
      { text: '<i class="fa-solid fa-calendar-days"></i> 18-09-2001 <i class="fa-solid fa-calendar-days"></i>', effect: "slideIn" },
    ];
    let msgIndex = 0;
    const messageEl = document.getElementById("message");

    // FIXED: showNextMessage now only shows the form AFTER all messages finished
    function showNextMessage(){
  if(msgIndex >= messages.length){
    // Hi·ªán thi·ªáp PNG thay v√¨ ch·ªØ
    const card = document.getElementById("cardImage");
    card.style.display = "block";
    card.classList.add("slideFlipIn");


    // Sau khi hi·ªán thi·ªáp ‚Üí ƒë·ª£i 10s r·ªìi m·ªõi hi·ªán form
    setTimeout(()=>{
      document.getElementById("giftChoice").style.display = "block";
    }, 12000);
    return;
  }

  const { text, effect } = messages[msgIndex];
  messageEl.className = 'scene';
  setTimeout(()=>{
    messageEl.innerHTML = text;
    // N·∫øu text l√† s·ªë ƒë·∫øm th√¨ th√™m class countdown
    if(["3","2","1"].includes(text)){
      messageEl.classList.add("countdown");
    }
    messageEl.classList.add(effect);
    msgIndex++;
    if(msgIndex < messages.length){
      setTimeout(showNextMessage, 2500);
    } else {
      // Sau khi hi·ªán xong d√≤ng cu·ªëi ‚Üí s·∫Ω nh·∫£y sang card
      setTimeout(showNextMessage, 2500);
    }
  }, 160);
}
    function startSequence(){
      msgIndex = 0;
      showNextMessage();
    }

    /* ========== BACKGROUND FLYING TEXT ========== */
    const canvas = document.getElementById("bg");
    const ctx = canvas.getContext("2d");
    function resizeCanvas(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    const flyMessages = [
      "üéâ Happy Birthday üíñ", "üéÅ Wish you achieve all goals of career üåü", "üéÇ Love you üíï",
      "üéà My sunshine üåû", "üíû Sending you smiles üíû", "üéä Best wishes üéâ" , 
      "üéà All the best on your special day! üéÅ", "üíû Many more happy returns! üíû", "üéä Missing you üéâ" 
    ];
    class FloatingText {
      constructor() { this.reset(); }
      reset(){
        this.text = flyMessages[Math.floor(Math.random() * flyMessages.length)];
        this.x = Math.random() * canvas.width;
        this.y = canvas.height + 50 + Math.random()*200;
        this.speed = 0.6 + Math.random() * 2;
        this.size = 18 + Math.random() * 28;
        this.color = "rgba(255,182,193,0.9)";
        this.alpha = 0.9;
      }
      draw(){
        ctx.font = `${this.size}px Pacifico, cursive`;
        ctx.fillStyle = this.color;
        ctx.fillText(this.text, this.x, this.y);
      }
      update(){
        this.y -= this.speed;
        if(this.y < -80) this.reset();
        this.draw();
      }
    }

    const texts = [];
    for(let i=0;i<26;i++) texts.push(new FloatingText());
    function animate(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      texts.forEach(t=>t.update());
      requestAnimationFrame(animate);
    }
    animate();

    /* ========== CONFETTI ========= */
    function createConfetti(){
      const confetti = document.createElement("div");
      confetti.classList.add("confetti");
      document.body.appendChild(confetti);
      confetti.style.left = Math.random() * window.innerWidth + "px";
      confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 50%)`;
      confetti.style.animationDuration = 3 + Math.random() * 2 + "s";
      confetti.style.opacity = Math.random();
      setTimeout(()=> confetti.remove(), 5200);
    }
    setInterval(createConfetti, 160);

    /* ========== MUSIC CONTROL & AUTOPLAY HANDLING ========= */
    const music = document.getElementById('music');
    const toggleBtn = document.getElementById('toggleMusic');

    function tryPlayMusicOnUnlock(){
      music.play().then(()=>{ toggleBtn.textContent = "üîä"; }).catch(()=>{ toggleBtn.textContent = "üîá"; });
    }

    toggleBtn.addEventListener('click', ()=>{
      if(music.paused){ music.play().then(()=> toggleBtn.textContent = "üîä").catch(()=>{ toggleBtn.textContent = "üîá"; }); }
      else { music.pause(); toggleBtn.textContent = "üîá"; }
    });

    document.body.addEventListener('click', ()=>{
      if(lockOverlay.style.display === 'none'){ if(music.paused) music.play().catch(()=>{}); }
    }, { once: true });

    /* ========== WHEN UNLOCK HAPPENS START SEQUENCE ========== */
    const obs = new MutationObserver((mut)=>{
      if(window.getComputedStyle(lockOverlay).display === 'none'){ startSequence(); }
    });
    obs.observe(lockOverlay, { attributes: true, attributeFilter: ['style'] });

    if(window.getComputedStyle(lockOverlay).display === 'none'){ startSequence(); }

    /* Accessibility */
    const firstBtn = kbd.querySelector('button');
    if(firstBtn) firstBtn.tabIndex = 0;

    function checkOrientation() {
      if (window.innerHeight > window.innerWidth) {
        document.getElementById("rotateNotice").style.display = "flex";
        document.body.style.overflow = "hidden";
      } else {
        document.getElementById("rotateNotice").style.display = "none";
        document.body.style.overflow = "auto";
      }
    }
    window.addEventListener("resize", checkOrientation);
    window.addEventListener("orientationchange", checkOrientation);
    checkOrientation();
  </script>

  <!-- ===== form submit (calls modular saveSubmission) ===== -->
  <script>
    const form = document.getElementById("infoForm");
    form.addEventListener("submit", function(e){
      e.preventDefault();
      const phone = document.getElementById("phone").value.trim();
      const address = document.getElementById("address").value.trim();
      if(!phone || !address){ alert('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i v√† ƒë·ªãa ch·ªâ'); return; }

      if(typeof window.saveSubmission !== 'function'){
        alert('Firebase ch∆∞a s·∫µn s√†ng. Vui l√≤ng ch·ªù r·ªìi th·ª≠ l·∫°i (m·ªü console ƒë·ªÉ xem l·ªói).');
        return;
      }

    window.saveSubmission(phone, address)
    .then(()=> {
      form.reset();
      // ·∫®n form, hi·ªán overlay
      document.getElementById("giftForm").style.display = "none";
      document.getElementById("successOverlay").style.display = "block";
      startFireworks(); // g·ªçi hi·ªáu ·ª©ng ph√°o hoa
})
    });
    let giftChoiceValue = ""; // l∆∞u l·ª±a ch·ªçn C√≥ / Kh√¥ng
    function startFireworks(){
  const canvas = document.getElementById("fireworks");
  const ctx = canvas.getContext("2d");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  let particles = [];

  class Particle {
    constructor(x, y, color){
      this.x = x;
      this.y = y;
      this.color = color;
      this.radius = Math.random()*3+2;
      this.angle = Math.random()*2*Math.PI;
      this.speed = Math.random()*6+2;
      this.life = 100;
    }
    update(){
      this.x += Math.cos(this.angle)*this.speed;
      this.y += Math.sin(this.angle)*this.speed;
      this.speed *= 0.95; // gi·∫£m t·ªëc
      this.life--;
    }
    draw(){
      ctx.beginPath();
      ctx.arc(this.x,this.y,this.radius,0,2*Math.PI);
      ctx.fillStyle=this.color;
      ctx.fill();
    }
  }

  function createFirework(){
    let x = Math.random()*canvas.width;
    let y = Math.random()*canvas.height*0.6;
    let colors = ["#ff1744","#ff9100","#ffea00","#00e676","#2979ff","#d500f9"];
    for(let i=0;i<60;i++){
      particles.push(new Particle(x,y,colors[Math.floor(Math.random()*colors.length)]));
    }
  }

  function animate(){
    ctx.fillStyle="rgba(0,0,0,0.2)";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    particles.forEach((p,i)=>{
      p.update();
      p.draw();
      if(p.life<=0) particles.splice(i,1);
    });
    requestAnimationFrame(animate);
  }

  setInterval(createFirework, 1000);
  animate();
}
document.getElementById("btnYes").addEventListener("click", ()=>{
  giftChoiceValue = "C√≥";   // üëà l∆∞u l·ª±a ch·ªçn
  document.getElementById("giftChoice").style.display = "none";
  document.getElementById("giftForm").style.display = "block";
});

document.getElementById("btnNo").addEventListener("click", ()=>{
  giftChoiceValue = "Kh√¥ng"; // üëà l∆∞u l·ª±a ch·ªçn
  const funny = document.getElementById("funnyMsg");
  funny.textContent = "üòè Sinh nh·∫≠t m√† kh√¥ng c√≥ qu√† th√¨ bu·ªìn l·∫Øm ! üòè";
  funny.style.display = "block";
  setTimeout(()=>{
    document.getElementById("giftChoice").style.display = "none";
    document.getElementById("giftForm").style.display = "block";
  }, 3000);
});
  </script>
  <!-- Hi·ªáu ·ª©ng sau khi g·ª≠i -->
  <div id="successOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:10000; text-align:center; color:white;">
    <div style="position:absolute; top:40%; left:50%; transform:translate(-50%,-50%);">
      <div style="font-size:80px; margin-bottom:20px;">ü•≥üéÅüéâ</div>
      <h2>üì± Ch√∫ √Ω ƒëi·ªán tho·∫°i, ƒë·ª£i qu√† ƒë·∫øn nha!</h2>
    </div>
    <canvas id="fireworks" style="position:absolute; inset:0;"></canvas>
  </div>
  <!-- ========== Extra PIN Screen ========== -->
<div id="extraPasswordOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.9); z-index:11000; color:white; text-align:center; padding:20px;">
  <div class="lock-card" style="margin:auto;">
    <div class="lock-header">
      <div class="lock-icon">üîê</div>
      <div class="lock-title">
        <h3>M·∫≠t kh·∫©u ·ªü trong qu√† </h3>
        <p>ƒêo√°n ƒë∆∞·ª£c m·∫≠t kh·∫©u th√¨ qu√° gi·ªèi-thua üòè</p>
        <p id="extraPassMsg" style="margin-top:12px; font-size:1rem;"></p>
      </div>
    </div>

    <!-- hi·ªÉn th·ªã ch·∫•m PIN -->
    <div class="pin-display" id="extraPinDisplay">
      <div class="dot" data-pos="0"></div>
      <div class="dot" data-pos="1"></div>
      <div class="dot" data-pos="2"></div>
      <div class="dot" data-pos="3"></div>
    </div>

    <!-- keypad -->
    <div class="kbd" id="extraKbd"></div>
    
  </div>
</div>

<!-- Hi·ªáu ·ª©ng ch·ªØ l·∫•p l√°nh -->
<style>
  .sparkle {
    font-size: 2.5rem;
    font-weight: bold;
    color: #fff;
    text-shadow: 0 0 10px #ff69b4, 0 0 20px #ff1493, 0 0 40px #ff69b4;
    animation: glow 1.5s infinite alternate;
  }
  @keyframes glow {
    from { text-shadow: 0 0 10px #ff69b4, 0 0 20px #ff1493; }
    to   { text-shadow: 0 0 20px #fff, 0 0 40px #ff69b4, 0 0 60px #ff1493; }
  }
</style>

<script>
  // ==== N√∫t "‚û°Ô∏è Ti·∫øp t·ª•c" trong successOverlay ====
  const successOverlay = document.getElementById("successOverlay");
  const continueBtn = document.createElement("button");
  continueBtn.textContent = "‚û°Ô∏è Ph·∫ßn 2";
  continueBtn.style.cssText = "margin-top:20px; padding:10px 20px; border:none; border-radius:8px; background:lightgreen; font-weight:bold; cursor:pointer; font-size:1.1rem;";
  continueBtn.style.display = "none";
  successOverlay.querySelector("div").appendChild(continueBtn);

  // Sau 4 gi√¢y m·ªõi hi·ªán n√∫t
  setTimeout(()=>{ continueBtn.style.display="inline-block"; }, 4000);

  // Khi b·∫•m m·ªü overlay m·∫≠t kh·∫©u ph·ª•
  continueBtn.addEventListener("click", ()=>{
    successOverlay.style.display="none";
    document.getElementById("extraPasswordOverlay").style.display="flex";
  });

  // ==== Logic m·∫≠t kh·∫©u ph·ª• ====
  const EXTRA_CORRECT = "2223"; // üîë m·∫≠t kh·∫©u ph·ª• (ƒë·ªïi tu·ª≥ √Ω)
  let extraInputPin = "";

  const extraPinDots = document.querySelectorAll('#extraPinDisplay .dot');
  const extraKbd = document.getElementById('extraKbd');
  const extraCard = document.querySelector('#extraPasswordOverlay .lock-card');
  const extraMsg = document.getElementById('extraPassMsg');

  // keypad layout
  const extraKeys = ['1','2','3','4','5','6','7','8','9','C','0','‚Üê'];
  extraKeys.forEach(k=>{
    const b = document.createElement('button');
    b.className = 'btn' + (k==='C' || k==='‚Üê' ? ' gray' : '');
    b.innerHTML = (k === '‚Üê') ? '‚å´' : (k==='C' ? 'C' : k);
    b.setAttribute('data-key', k);
    extraKbd.appendChild(b);
  });

  function updateExtraDots(){
    extraPinDots.forEach((d,i)=>{
      if(i < extraInputPin.length) d.classList.add('filled'); 
      else d.classList.remove('filled');
    });
  }

  function wrongExtraPin(){
    extraCard.classList.remove('shake');
    void extraCard.offsetWidth;
    extraCard.classList.add('shake');
    setTimeout(()=> extraCard.classList.remove('shake'), 700);
    extraMsg.textContent = "ƒê·ª£i qu√† ƒë·∫øn nha üò¢ kh√≥ ƒë·∫•y !";
    extraMsg.style.color = "red";

    // üî• Ghi log v√†o Firebase
    if(typeof window.logWrongExtraPassword === 'function'){
      window.logWrongExtraPassword(extraInputPin);
    }
  }
  function unlockExtra(){
    // ·∫®n keypad, hi·ªán th√¥ng ƒëi·ªáp
    document.getElementById("extraPinDisplay").style.display="none";
    extraKbd.style.display="none";
    extraMsg.innerHTML = '<div class="sparkle">üíñ ANH NH·ªö EM ! üíñ</div>';
    extraMsg.style.color="white";
  }

  extraKbd.addEventListener('click', e=>{
    const btn = e.target.closest('button');
    if(!btn) return;
    const k = btn.getAttribute('data-key');

    if(k === 'C'){ extraInputPin = ''; updateExtraDots(); return; }
    if(k === '‚Üê'){ extraInputPin = extraInputPin.slice(0,-1); updateExtraDots(); return; }
    if(extraInputPin.length >= 4) return;
    extraInputPin += k;
    updateExtraDots();

    if(extraInputPin.length === 4){
      setTimeout(()=>{
        if(extraInputPin === EXTRA_CORRECT) unlockExtra();
        else { wrongExtraPin(); extraInputPin=''; updateExtraDots(); }
      }, 300);
    }
  });
</script>

</body>
</html>
